{"version":3,"sources":["../../src/components/App.js"],"names":["STATE","LOADING","READY","ERROR","NEEDS_AUTH","AUTHENTICATING","NOT_FOUND","App","props","toast","getAuthURL","authResponse","logout","namespace","site","setSite","deploys","setDeploys","React","useState","isSitePrivate","setIsSitePrivate","state","setState","needsSetup","oauthClientId","isLoggedIn","needsAuth","requestOptions","headers","Authorization","access_token","useEffect","siteId","then","res","ok","status","Error","statusText","json","setTimeout","catch","initOrRefreshApp","interval","setInterval","push","title","APP_REFRESH_INTERVAL","clearInterval","handleTriggerBuild","clearCache","id","handleClickAuthorize","window","location","href","handleClickLogout","localStorage","removeItem","IDLE","studioTheme","marginRight","ArrowRightIcon","map","deploy"],"mappings":"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","sourcesContent":["/* eslint-disable react/jsx-no-bind */\nimport React from \"react\";\nimport {\n  Container,\n  Heading,\n  Card,\n  Stack,\n  Box,\n  Flex,\n  Text,\n  Button,\n  Inline,\n  Menu,\n  MenuItem,\n  MenuButton,\n  useToast,\n  ThemeProvider,\n  studioTheme,\n} from \"@sanity/ui\";\nimport DeployItem from \"./DeployItem\";\nimport { useNetlifyAuth } from \"../hooks\";\nimport { siteId, oauthClientId } from \"../config\";\nimport { getSiteDeploys, getSite, postSiteNewBuild } from \"../utils\";\nimport { useLocalStorage } from \"../hooks\";\nimport { namespace, APP_REFRESH_INTERVAL } from \"../config\";\nimport { ArrowRightIcon } from \"@sanity/icons\";\n\nconst STATE = {\n  LOADING: \"loading\",\n  READY: \"ready\",\n  ERROR: \"error\",\n  NEEDS_AUTH: \"needs_auth\",\n  AUTHENTICATING: \"authenticating\",\n  NOT_FOUND: \"site_not_found\",\n};\n\nexport default function App(props) {\n  const toast = useToast();\n  const { getAuthURL, authResponse, logout } = useNetlifyAuth();\n\n  const [site, setSite] = useLocalStorage(`${namespace}--site`);\n  const [deploys, setDeploys] = useLocalStorage(`${namespace}--deploys`);\n  const [isSitePrivate, setIsSitePrivate] = React.useState(false);\n  const [state, setState] = React.useState(\"idle\"); // (loading > ready | error), (loading > needs_auth > authenticating > error | ready)\n\n  const needsSetup = !oauthClientId;\n  const isLoggedIn = authResponse;\n  const needsAuth = !needsSetup && !isLoggedIn;\n  const requestOptions = isLoggedIn\n    ? {\n        headers: { Authorization: `Bearer ${authResponse.access_token}` },\n      }\n    : null;\n\n  // Check if we need auth, if not, good :)\n  React.useEffect(() => {\n    setState(STATE.LOADING);\n    getSiteDeploys(siteId)\n      .then((res) => {\n        if (!res.ok && res.status === 401) throw new Error(res.statusText);\n        return res;\n      })\n      .then((res) => res.json())\n      .then(setDeploys)\n      .then(() => setTimeout(() => setState(STATE.READY), 1000))\n      .then(() => {\n        getSite(siteId)\n          .then((res) => res.json())\n          .then(setSite);\n      })\n      .catch(() => {\n        setState(STATE.NEEDS_AUTH);\n        setIsSitePrivate(true);\n      });\n  }, [siteId]);\n\n  // We need auth here\n  React.useEffect(() => {\n    if (state === STATE.NEEDS_AUTH && isSitePrivate && siteId && isLoggedIn) {\n      initOrRefreshApp();\n    }\n  }, [isSitePrivate, siteId, isLoggedIn]);\n\n  // Refresh App on every interval\n  React.useEffect(() => {\n    let interval;\n    if (state === STATE.READY) {\n      interval = setInterval(() => {\n        toast.push({\n          title: `Refreshing site deploys...`,\n          status: \"info\",\n        });\n        initOrRefreshApp();\n      }, APP_REFRESH_INTERVAL);\n    }\n    return () => clearInterval(interval);\n  }, []);\n\n  function initOrRefreshApp() {\n    getSite(siteId, requestOptions)\n      .then((res) => res.json())\n      .then(setSite);\n    getSiteDeploys(siteId, requestOptions)\n      .then((res) => {\n        if (!res.ok) throw new Error(res.statusText);\n        return res;\n      })\n      .then((res) => res.json())\n      .then(setDeploys)\n      .then(() => setTimeout(() => setState(STATE.READY), 1000))\n      .catch(() => {\n        if (isSitePrivate) {\n          setState(STATE.ERROR);\n        }\n      });\n  }\n\n  function handleTriggerBuild(clearCache = false) {\n    postSiteNewBuild({\n      siteId: site.id,\n      clearCache,\n      headers: requestOptions.headers,\n    })\n      .then((res) => {\n        if (!res.ok) throw new Error(res.statusText);\n        return res;\n      })\n      .then(() => {\n        toast.push({\n          title: `Successfully triggered new build ${\n            clearCache ? \"without cache\" : \"\"\n          }!`,\n          status: \"success\",\n        });\n        initOrRefreshApp();\n      })\n      .catch(() => {\n        toast.push({\n          title: `Oops, unable to trigger new build`,\n          status: \"warning\",\n        });\n      });\n  }\n\n  function handleClickAuthorize() {\n    return (window.location.href = getAuthURL());\n  }\n\n  function handleClickLogout() {\n    return logout().then(() => {\n      if (isSitePrivate) {\n        setDeploys([]);\n        window.localStorage.removeItem(`${namespace}--site`);\n        window.localStorage.removeItem(`${namespace}--deploys`);\n      }\n      setState(STATE.IDLE);\n    });\n  }\n\n  return (\n    <ThemeProvider theme={studioTheme}>\n      <Container>\n        <Box margin={2} padding={4} radius={2}>\n          <Flex justify=\"space-between\" align=\"center\">\n            <Stack space={4}>\n              <Heading size={3} as=\"h2\">\n                <Flex marginRight={5} align=\"center\">\n                  <span style={{ marginRight: 10 }}>Site Deploys</span>\n                </Flex>\n              </Heading>\n              <Text muted>Displaying your recent site deploys.</Text>\n            </Stack>\n            <Stack space={3}>\n              {needsSetup && (\n                <>\n                  <Button\n                    as=\"a\"\n                    text=\"Click here to setup OAuth\"\n                    href=\"https://github.com/dorelljames/sanity-plugin-netlify-deploy-status-badge#configuration\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                  />\n                  <Text muted size={1}>\n                    {isSitePrivate\n                      ? \"Setup Netlify's OAuth and login to view site deploys, etc.\"\n                      : \"Setup OAuth to trigger a new build.\"}\n                  </Text>\n                </>\n              )}\n              {needsAuth && (\n                <>\n                  <Button\n                    text=\"Login at Netlify\"\n                    onClick={handleClickAuthorize}\n                    tone=\"positive\"\n                  />\n                  <Text muted size={1}>\n                    {isSitePrivate\n                      ? \"Login in order to view site's deploy log and trigger a new build\"\n                      : \"Login in order to trigger a new build\"}\n                  </Text>\n                </>\n              )}\n              {isLoggedIn && (\n                <Flex>\n                  <Inline space={2}>\n                    {state === \"ready\" && (\n                      <MenuButton\n                        button={<Button text=\"Trigger Deploy\" />}\n                        id=\"menu-button-example\"\n                        menu={\n                          <Menu>\n                            <MenuItem\n                              text=\"Deploy site\"\n                              onClick={() => handleTriggerBuild()}\n                            />\n                            <MenuItem\n                              text=\"Clear cache and deploy site\"\n                              onClick={() => handleTriggerBuild(true)}\n                            />\n                          </Menu>\n                        }\n                      />\n                    )}\n                    <Button\n                      text=\"Logout\"\n                      onClick={handleClickLogout}\n                      icon={ArrowRightIcon}\n                    />\n                  </Inline>\n                </Flex>\n              )}\n            </Stack>\n          </Flex>\n        </Box>\n\n        <Card margin={4}>\n          <Stack as=\"ul\">\n            {state === \"error\" && (\n              <Card padding={4} radius={2} tone=\"critical\">\n                <Stack space={4}>\n                  <Heading>Oh nooo! Something went wrong here...</Heading>\n                  <Text>\n                    Please make sure you have access to the site configured. Try\n                    refreshing this page. If error still persists, please\n                    contact plugin author\n                    <a\n                      href=\"mailto:netlify-deploy-status-badge+galangdj@gmail.com\"\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                    >\n                      @dorelljames\n                    </a>{\" \"}\n                    or your developer.\n                  </Text>\n                </Stack>\n              </Card>\n            )}\n\n            {(state === \"loading\" ||\n              (state === \"needs_auth\" && isLoggedIn)) && (\n              <Card borderBottom as=\"li\" padding={4} radius={2}>\n                <Text as=\"em\">Getting things ready...</Text>\n              </Card>\n            )}\n\n            {deploys?.map((deploy) => (\n              <DeployItem key={deploy.id} deploy={deploy} site={site} />\n            ))}\n          </Stack>\n        </Card>\n      </Container>\n    </ThemeProvider>\n  );\n}\n"],"file":"App.js"}